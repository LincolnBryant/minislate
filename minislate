#!/bin/bash

init() {
  for file in slate-config/*; do
    if [[ $(stat -c %U $file 2>/dev/null || stat -f '%Su' $file) != root ]]; then
      echo "Fixing ownership of $file."
      sudo chown root $file
    fi
    if [[ $(stat -c %a $file 2>/dev/null || stat -f '%A' $file) != 600 ]]; then
      echo "Fixing permissions of $file."
      sudo chmod 600 $file
    fi
  done
  docker-compose up -d
  docker-compose exec kube ./init.sh
  docker-compose exec slate helm init --service-account tiller
  docker-compose exec slate pip install -r /opt/slate-portal/requirements.txt
  docker-compose exec slate sh -c "sed -i 's/localhost/0\.0\.0\.0/g' /opt/slate-portal/run_*"
  docker-compose exec -d slate /bin/sh -c "cd /opt/slate-portal && ./run_portal.py"
}

stop() {
  docker-compose stop
}

start() {
  docker-compose start
}

destroy() {
  docker-compose down -v
}

build() {
  docker-compose build --no-cache $1
}

shell() {
  docker-compose exec $1 /bin/bash
}

slate() {
  docker-compose exec slate slate "$@"
}

kubectl() {
  docker-compose exec slate kubectl "$@"
}

exec() {
  docker compose exec "$@"
}

if [[ $1 =~ ^(init|start|stop|destroy|address|build|shell|slate|kubectl|exec)$ ]]; then
  "$@"
else
  echo "Invalid subcommand $1" >&2
  exit 1
fi
